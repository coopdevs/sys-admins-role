---
- name: Create group for system administration
  become: yes
  group:
    name: "{{ sys_admin_group }}"
    state: present
  when: sys_admin_group is defined

- name: Create users for system administration
  become: yes
  user:
    name: "{{ item.name }}"
    state: "{{ item.state }}"
    shell: "/bin/bash"
    groups: "{{ sys_admin_group }}"
    append: yes
  with_items: "{{ sys_admins }}"
  when: sys_admins is defined

- name: Add SSH public keys to system administrators
  become: yes
  authorized_key:
    user: "{{ item.name }}"
    key: "{{ lookup('file', item.ssh_key) }}"
    state: "{{ item.state }}"
  when: item.state == "present"
  with_items: "{{ sys_admins }}"
  when: sys_admins is defined

- name: Copy sudoers configuration for system administrators
  become: yes
  template:
    src: sudoers.j2
    dest: "/etc/sudoers.d/90-sys-admins"
    mode: 0440
    group: "{{ sys_admin_group }}"
  when: sys_admin_group is defined
